# 开屏广告黑屏问题修复

## 问题描述

用户反馈：启动页一闪就关闭了，还是黑屏

## 根本原因分析

1. **广告加载失败**：ZJSDK可能没有正确初始化或广告位配置有问题
2. **事件监听问题**：可能 `onAdLoaded` 事件不存在或不触发
3. **启动页显示时间太短**：即使广告失败，启动页也应该显示一段时间

## 解决方案

### 1. 确保启动页最小显示时间（2秒）

**问题**：如果广告立即失败，启动页会一闪而过

**解决**：
```dart
// 记录启动时间
DateTime? _startTime;
bool _minTimeReached = false;

// 设置最小显示时间
Future.delayed(const Duration(seconds: 2), () {
  _minTimeReached = true;
});

// 广告失败时，等待最小时间后再跳转
Future<void> _waitAndNavigate() async {
  if (_minTimeReached) {
    _navigateToMain();
  } else {
    final elapsed = DateTime.now().difference(_startTime!).inMilliseconds;
    final remaining = 2000 - elapsed;
    if (remaining > 0) {
      await Future.delayed(Duration(milliseconds: remaining));
    }
    _navigateToMain();
  }
}
```

### 2. 使用 onAdShow 而不是 onAdLoaded

**问题**：`onAdLoaded` 事件可能不存在或不触发

**解决**：改用 `onAdShow` 事件（广告开始展示时触发）
```dart
if (ret.action == ZJEventAction.onAdShow) {
  // 广告开始展示
  setState(() {
    _adLoaded = true;
    _showSplashContent = false;
  });
}
```

### 3. 添加详细的调试信息

**在Debug模式下显示**：
- 最小时间是否已到
- 广告加载状态
- 跳过按钮（方便测试）

```dart
if (AdConfig.isDebug)
  Column(
    children: [
      Text('最小时间: ${_minTimeReached ? "已到" : "未到"}'),
      Text('广告状态: ${_adLoaded ? "已加载" : "加载中"}'),
    ],
  ),
```

### 4. 添加跳过按钮（Debug模式）

方便开发时快速跳过广告测试：
```dart
if (AdConfig.isDebug)
  Positioned(
    top: MediaQuery.of(context).padding.top + 10,
    right: 10,
    child: TextButton(
      onPressed: _navigateToMain,
      child: const Text('跳过'),
    ),
  ),
```

## 优化后的流程

```
应用启动
  ↓
显示启动页（Logo + 加载动画）
  ↓
延迟500ms（等待SDK启动）
  ↓
加载开屏广告
  ↓
等待广告加载...
  ├─ 广告展示成功（onAdShow）
  │   ↓
  │  隐藏启动页，显示广告
  │   ↓
  │  用户关闭广告
  │   ↓
  │  跳转主页
  │
  ├─ 广告加载失败（onAdError）
  │   ↓
  │  等待最小显示时间（2秒）
  │   ↓
  │  跳转主页
  │
  └─ 超时（5秒）
      ↓
     跳转主页
```

## 关键改进

### 1. 最小显示时间保证
- 启动页至少显示2秒
- 避免一闪而过的体验
- 即使广告立即失败也不会黑屏

### 2. 更可靠的事件监听
- 使用 `onAdShow` 而不是 `onAdLoaded`
- 记录所有事件到日志
- 便于调试和排查问题

### 3. 调试友好
- Debug模式显示状态信息
- 提供跳过按钮
- 详细的日志输出

## 调试日志

运行应用后，查看日志：

```
🚀 开屏页面：开始加载开屏广告
📱 广告位ID: J8120762208
📱 应用ID: Z0062563231
📱 开始加载开屏广告，广告位ID: J8120762208
⏰ 启动页最小显示时间（2秒）已到
📢 开屏广告事件: action=xxx, msg=xxx
```

### 可能的日志输出

#### 场景1：广告加载成功
```
🚀 开屏页面：开始加载开屏广告
📱 广告位ID: J8120762208
📱 应用ID: Z0062563231
📱 开始加载开屏广告
📢 开屏广告事件: action=onAdShow, msg=null
✅ 开屏广告展示中
⏰ 启动页最小显示时间（2秒）已到
📢 开屏广告事件: action=onAdClose, msg=null
❌ 开屏广告关闭
🏠 跳转到主页
```

#### 场景2：广告加载失败
```
🚀 开屏页面：开始加载开屏广告
📱 广告位ID: J8120762208
📱 应用ID: Z0062563231
📱 开始加载开屏广告
📢 开屏广告事件: action=onAdError, msg=广告位不存在
⚠️ 开屏广告错误: 广告位不存在
⏰ 等待最小显示时间，剩余 1500ms
⏰ 启动页最小显示时间（2秒）已到
🏠 跳转到主页
```

#### 场景3：没有任何事件（SDK未启动）
```
🚀 开屏页面：开始加载开屏广告
📱 广告位ID: J8120762208
📱 应用ID: Z0062563231
📱 开始加载开屏广告
⏰ 启动页最小显示时间（2秒）已到
⏰ 开屏广告加载超时（5秒），跳转主页
🏠 跳转到主页
```

## 如何测试

### 1. 正常测试
```bash
flutter run
```

观察：
- 启动页是否至少显示2秒
- 是否有黑屏现象
- 查看日志中的广告事件

### 2. Debug模式测试

在Debug模式下，你会看到：
- 右上角的"跳过"按钮
- 屏幕中央的状态信息
  - "最小时间: 已到/未到"
  - "广告状态: 已加载/加载中"

### 3. 查看完整日志
```bash
flutter run --verbose 2>&1 | grep -E "(🚀|📱|📢|✅|❌|⚠️|⏰|🏠|ℹ️)"
```

## 可能的问题和解决方案

### 问题1：启动页显示2秒后跳转，没有看到广告

**原因**：广告加载失败或SDK未启动

**检查**：
1. 查看日志中是否有 `📢 开屏广告事件`
2. 如果没有任何事件，说明SDK未启动或广告加载失败
3. 检查 `lib/main.dart` 中的SDK启动日志

**解决**：
- 确认ZJSDK插件正确安装
- 检查广告位ID是否正确
- 查看是否有网络连接

### 问题2：看到广告事件但是广告不显示

**原因**：广告加载失败（onAdError）

**检查**：
1. 查看错误信息：`⚠️ 开屏广告错误: xxx`
2. 常见错误：
   - "广告位不存在" - 广告位ID错误
   - "网络错误" - 网络连接问题
   - "SDK未初始化" - SDK启动失败

**解决**：
- 检查 `AdConfig.splashAdId` 是否正确
- 确认网络连接正常
- 查看SDK初始化日志

### 问题3：启动页一直显示，不跳转

**原因**：超时机制未触发或导航失败

**检查**：
1. 查看是否有 `⏰ 开屏广告加载超时（5秒）` 日志
2. 查看是否有 `🏠 跳转到主页` 日志

**解决**：
- 点击右上角的"跳过"按钮（Debug模式）
- 重启应用

## 下一步

如果问题仍然存在，请提供：

1. **完整的启动日志**（从应用启动到跳转主页）
2. **是否看到任何广告事件**
3. **启动页显示了多长时间**
4. **是否有黑屏现象**

这些信息将帮助我们进一步诊断问题。

## 总结

这次修复主要解决了三个问题：

1. ✅ **启动页最小显示时间** - 至少显示2秒，避免一闪而过
2. ✅ **更可靠的事件监听** - 使用 `onAdShow` 而不是 `onAdLoaded`
3. ✅ **调试友好** - 添加状态显示和跳过按钮

现在启动页不会一闪而过了，即使广告加载失败也会显示至少2秒。
