# ğŸ”§ å®¢æœåŠŸèƒ½ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

ä»å•†å“è¯¦æƒ…é¡µç‚¹å‡»å®¢æœæŒ‰é’®åï¼ŒåŠŸèƒ½ä¸æ­£å¸¸ã€‚

## ğŸ¯ é—®é¢˜åŸå› 

1. **å•†å“è¯¦æƒ…é¡µä½¿ç”¨äº†æ—§çš„è·¯ç”±æ–¹å¼**
   - åŸä»£ç : `Get.toNamed(AppRoutes.chat, arguments: {'productId': _productId})`
   - æ²¡æœ‰ä½¿ç”¨æ–°åˆ›å»ºçš„ `CustomerService`

2. **CustomerService ä½¿ç”¨äº†ä¸å­˜åœ¨çš„è·¯ç”±**
   - åŸä»£ç ä½¿ç”¨ `AppRoutes.customerChat`
   - ä½†é¡¹ç›®ä¸­å·²æœ‰ `AppRoutes.chat` å’Œ `ChatPage`

## âœ… å·²å®Œæˆçš„ä¿®å¤

### ä¿®å¤ 1: æ›´æ–°å•†å“è¯¦æƒ…é¡µ

**æ–‡ä»¶**: `lib/app/modules/goods/goods_detail_page.dart`

**ä¿®æ”¹å†…å®¹**:

1. æ·»åŠ å¯¼å…¥:
```dart
import 'package:shuhang_mall_flutter/app/services/customer_service.dart';
```

2. ä¿®æ”¹å®¢æœæ–¹æ³•:
```dart
// ä¿®æ”¹å‰
void _goCustomerService() {
  Get.toNamed(AppRoutes.chat, arguments: {'productId': _productId});
}

// ä¿®æ”¹å
void _goCustomerService() {
  // ä½¿ç”¨å®¢æœæœåŠ¡æ‰“å¼€å®¢æœ
  CustomerService().openCustomerWithProduct(_productId);
}
```

### ä¿®å¤ 2: æ›´æ–° CustomerService

**æ–‡ä»¶**: `lib/app/services/customer_service.dart`

**ä¿®æ”¹å†…å®¹**:

```dart
// ä¿®æ”¹å‰
void _openInternalChat({String? url, int? productId}) {
  Get.toNamed(
    AppRoutes.customerChat, // ä¸å­˜åœ¨çš„è·¯ç”±
    parameters: parameters,
  );
}

// ä¿®æ”¹å
void _openInternalChat({String? url, int? productId}) {
  // ä½¿ç”¨ç°æœ‰çš„èŠå¤©é¡µé¢
  Get.toNamed(
    AppRoutes.chat, // ä½¿ç”¨å·²å­˜åœ¨çš„è·¯ç”±
    arguments: {
      'productId': productId,
      'to_uid': 0,
      'type': 1,
    },
  );
}
```

## ğŸ‰ ç°åœ¨çš„å·¥ä½œæµç¨‹

### ç”¨æˆ·æ“ä½œæµç¨‹

1. ç”¨æˆ·åœ¨å•†å“è¯¦æƒ…é¡µç‚¹å‡»"å®¢æœ"æŒ‰é’®
2. è°ƒç”¨ `_goCustomerService()` æ–¹æ³•
3. æ‰§è¡Œ `CustomerService().openCustomerWithProduct(_productId)`
4. `CustomerService` è°ƒç”¨åç«¯ API `get_customer_type`
5. æ ¹æ®è¿”å›çš„å®¢æœç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œ:
   - **ç±»å‹ 0**: è·³è½¬åˆ° `ChatPage` (ç«™å†…å®¢æœ)
   - **ç±»å‹ 1**: æ‹¨æ‰“å®¢æœç”µè¯
   - **ç±»å‹ 2**: æ‰“å¼€ç¬¬ä¸‰æ–¹å®¢æœé“¾æ¥

### ä»£ç è°ƒç”¨é“¾

```
å•†å“è¯¦æƒ…é¡µ
  â†“
_goCustomerService()
  â†“
CustomerService().openCustomerWithProduct(productId)
  â†“
openCustomer(productId: productId)
  â†“
getCustomerType() API
  â†“
æ ¹æ®å®¢æœç±»å‹:
  - Type 0 â†’ _openInternalChat() â†’ Get.toNamed(AppRoutes.chat)
  - Type 1 â†’ _makePhoneCall()
  - Type 2 â†’ _openThirdPartyCustomer()
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•ç«™å†…å®¢æœ (Type 0)

**åç«¯é…ç½®**:
```json
{
  "status": 200,
  "msg": "success",
  "data": {
    "customer_type": "0"
  }
}
```

**é¢„æœŸç»“æœ**: è·³è½¬åˆ° ChatPageï¼Œæ˜¾ç¤ºå•†å“ID

### 2. æµ‹è¯•ç”µè¯å®¢æœ (Type 1)

**åç«¯é…ç½®**:
```json
{
  "status": 200,
  "msg": "success",
  "data": {
    "customer_type": "1",
    "customer_phone": "400-123-4567"
  }
}
```

**é¢„æœŸç»“æœ**: æ‰“å¼€ç³»ç»Ÿæ‹¨å·ç•Œé¢

### 3. æµ‹è¯•ç¬¬ä¸‰æ–¹å®¢æœ (Type 2)

**åç«¯é…ç½®**:
```json
{
  "status": 200,
  "msg": "success",
  "data": {
    "customer_type": "2",
    "customer_url": "https://example.com/customer"
  }
}
```

**é¢„æœŸç»“æœ**: åœ¨ WebView ä¸­æ‰“å¼€å®¢æœé“¾æ¥

## ğŸ“‹ éªŒè¯æ¸…å•

- [x] å•†å“è¯¦æƒ…é¡µå·²å¯¼å…¥ `CustomerService`
- [x] `_goCustomerService` æ–¹æ³•å·²æ›´æ–°
- [x] `CustomerService` ä½¿ç”¨æ­£ç¡®çš„è·¯ç”±
- [x] ä»£ç æ— è¯­æ³•é”™è¯¯
- [ ] åç«¯ API è¿”å›æ­£ç¡®æ ¼å¼
- [ ] æµ‹è¯•ç«™å†…å®¢æœè·³è½¬
- [ ] æµ‹è¯•ç”µè¯å®¢æœæ‹¨æ‰“
- [ ] æµ‹è¯•ç¬¬ä¸‰æ–¹å®¢æœæ‰“å¼€

## ğŸ” å¦‚ä½•éªŒè¯ä¿®å¤

### æ–¹æ³• 1: ç›´æ¥æµ‹è¯•

1. è¿è¡Œåº”ç”¨: `flutter run`
2. è¿›å…¥ä»»æ„å•†å“è¯¦æƒ…é¡µ
3. ç‚¹å‡»åº•éƒ¨çš„"å®¢æœ"æŒ‰é’®
4. è§‚å¯Ÿæ˜¯å¦æ­£å¸¸è·³è½¬åˆ°èŠå¤©é¡µé¢

### æ–¹æ³• 2: æŸ¥çœ‹æ—¥å¿—

åœ¨ç‚¹å‡»å®¢æœæŒ‰é’®åï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—:

```
flutter: === å¼€å§‹æ‰“å¼€å®¢æœ ===
flutter: å•†å“ID: 123
flutter: æ­£åœ¨è·å–å®¢æœé…ç½®...
flutter: APIå“åº”: status=200, msg=success
flutter: å®¢æœç±»å‹: 0
flutter: è·³è½¬åˆ°èŠå¤©é¡µé¢
```

### æ–¹æ³• 3: æ·»åŠ è°ƒè¯•ä»£ç 

åœ¨ `_goCustomerService` æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—:

```dart
void _goCustomerService() {
  debugPrint('ç‚¹å‡»å®¢æœæŒ‰é’®ï¼Œå•†å“ID: $_productId');
  CustomerService().openCustomerWithProduct(_productId);
}
```

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. ç»Ÿä¸€å®¢æœå…¥å£

ç°åœ¨æ‰€æœ‰å®¢æœåŠŸèƒ½éƒ½é€šè¿‡ `CustomerService` ç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äº:
- ç»Ÿä¸€å¤„ç†ä¸åŒå®¢æœç±»å‹
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- ç»Ÿä¸€æ—¥å¿—è®°å½•
- ä¾¿äºåç»­ç»´æŠ¤

### 2. å¤ç”¨ç°æœ‰é¡µé¢

ä½¿ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„ `ChatPage`ï¼Œé¿å…:
- é‡å¤å¼€å‘
- ä»£ç å†—ä½™
- ç»´æŠ¤æˆæœ¬å¢åŠ 

### 3. çµæ´»çš„å®¢æœç±»å‹

æ”¯æŒä¸‰ç§å®¢æœç±»å‹ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚çµæ´»åˆ‡æ¢:
- ç«™å†…å®¢æœ: é€‚åˆéœ€è¦å®Œæ•´èŠå¤©åŠŸèƒ½çš„åœºæ™¯
- ç”µè¯å®¢æœ: é€‚åˆéœ€è¦å³æ—¶æ²Ÿé€šçš„åœºæ™¯
- ç¬¬ä¸‰æ–¹å®¢æœ: é€‚åˆå·²æœ‰å®¢æœç³»ç»Ÿçš„åœºæ™¯

## ğŸš€ ä¸‹ä¸€æ­¥

### å¿…éœ€ä»»åŠ¡

1. **é…ç½®åç«¯ API**
   - ç¡®ä¿ `get_customer_type` æ¥å£æ­£å¸¸è¿”å›
   - é…ç½®æ­£ç¡®çš„å®¢æœç±»å‹

2. **æµ‹è¯•æ‰€æœ‰å®¢æœç±»å‹**
   - æµ‹è¯•ç«™å†…å®¢æœè·³è½¬
   - æµ‹è¯•ç”µè¯æ‹¨æ‰“ (éœ€è¦çœŸæœº)
   - æµ‹è¯•ç¬¬ä¸‰æ–¹å®¢æœæ‰“å¼€

### å¯é€‰ä»»åŠ¡

1. **å®Œå–„ ChatPage**
   - é›†æˆèŠå¤© SDK (ç¯ä¿¡/èäº‘/è…¾è®¯äº‘IM)
   - å®ç°æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
   - æ·»åŠ å›¾ç‰‡/æ–‡ä»¶å‘é€åŠŸèƒ½

2. **æ·»åŠ å®¢æœæµ®åŠ¨æŒ‰é’®**
   - åœ¨å•†å“è¯¦æƒ…é¡µæ·»åŠ  `CustomerFloatButton`
   - å¯æ‹–åŠ¨è°ƒæ•´ä½ç½®

3. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - ä¼˜åŒ–é”™è¯¯æç¤º
   - æ·»åŠ å®¢æœåœ¨çº¿çŠ¶æ€æ˜¾ç¤º

## ğŸ“ å¦‚æœè¿˜æœ‰é—®é¢˜

### é—®é¢˜ 1: ç‚¹å‡»åæ²¡æœ‰ååº”

**æ£€æŸ¥**:
1. æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—
2. ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ
3. API è¿”å›æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®

**è§£å†³**: æŸ¥çœ‹ `CUSTOMER_TROUBLESHOOTING.md`

### é—®é¢˜ 2: è·³è½¬åˆ°é”™è¯¯é¡µé¢

**æ£€æŸ¥**:
1. è·¯ç”±é…ç½®æ˜¯å¦æ­£ç¡®
2. `AppRoutes.chat` æ˜¯å¦å·²å®šä¹‰
3. `ChatPage` æ˜¯å¦å·²æ³¨å†Œ

**è§£å†³**: æ£€æŸ¥ `lib/app/routes/app_pages.dart`

### é—®é¢˜ 3: API è¯·æ±‚å¤±è´¥

**æ£€æŸ¥**:
1. åç«¯æ¥å£æ˜¯å¦æ­£å¸¸
2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
3. API åœ°å€æ˜¯å¦æ­£ç¡®

**è§£å†³**: ä½¿ç”¨ Postman æµ‹è¯• API

## âœ¨ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæˆ‘ä»¬:

1. âœ… ç»Ÿä¸€äº†å®¢æœåŠŸèƒ½å…¥å£
2. âœ… å¤ç”¨äº†ç°æœ‰çš„èŠå¤©é¡µé¢
3. âœ… æ”¯æŒäº†å¤šç§å®¢æœç±»å‹
4. âœ… å®Œå–„äº†é”™è¯¯å¤„ç†
5. âœ… æä¾›äº†è¯¦ç»†çš„æ–‡æ¡£

ç°åœ¨ä»å•†å“è¯¦æƒ…é¡µç‚¹å‡»å®¢æœåº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼ğŸ‰

---

**ä¿®å¤æ—¶é—´**: 2024-02-01
**ä¿®å¤æ–‡ä»¶**: 2ä¸ª
**æµ‹è¯•çŠ¶æ€**: å¾…æµ‹è¯•
